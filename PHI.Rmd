---
title: "PHI"
output: html_document
date: "2023-09-09"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
require(jtools)
require(smerc) 
require(gstat)
require(knitr)
require(MASS)
require(corrplot)
require(tmap)
require(animation)
require(zoo)
require(readODS)
require(tidyquant)
require(spdep)
require(tmap)
require(tidyquant)
```

## R Markdown

This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document. You can embed an R code chunk like this:

```{r}
library(car)
library(tidyverse)
library(sf)
library(ggplot2)
library(tab)
library(texreg)
library(ggpubr)
library(terra)
library(data.table)
library(gapminder)
library(tidyquant)
library(plotly)
library(ARPALData)
library(shinyjs)
library(shiny)
library(tmaptools)
library(plotly)
library(incidence)
library(xts)
library(bigmemory)
library(ff)
library(plyr)
library(ggplot2)
library(grid)
library(dplyr)
library(tidyr)
library(lubridate)
library(dygraphs)
library(zoo)
library(heatmaply)
library(ggcorrplot)
library(openair)
library(rcompanion)
library(lattice)
library(aplpack)
library(tcltk)
library(maps)
library(mapview)
library(vars)
library(sjPlot)
library(sjmisc)
library(likert)
library(expss)
library(openxlsx)
library(strucchange)
library(ltm)
library(corrr)
library(modeest)
library(tableone)
library(Hmisc)
library(modelsummary)
library(foreign) 
library(lavaan)
library(corrr)
library(gtsummary)
library(gridExtra)
library(leaflet)
library(haven)
library(labelled)
library(sjlabelled)
library(hrbrthemes)
library(extrafont)
library(survey)
library(naniar)
Sys.setenv(LANG = "en")
library(srvyr)
library(weights)
library(pscl)
library(wCorr)
library(boot)
library(ggiraph)
library(vcd)
library(plm)
library(lfe)
library(descriptio)
library(pollster)
library(plm)
library(nlme)
library(lmerTest)
library(piecewiseSEM)
library(mvtnorm)
#install.packages("mvtnorm")
```


##Loading country datasets
#We will use four files from the DHS dataset for each country (Household recode (HR), Children recode (KR) and Individual recode (IR))

```{r}
#Benin
dhs_benin_kr<-read_sas("E:/Lenovo data/Healthy diets for Afrika/DHS/DHS country datasets/Benin/Children_recode_BJKR71SD/BJKR71FL.SAS7BDAT")
dhs_benin_hr<-read_sas("E:/Lenovo data/Healthy diets for Afrika/DHS/DHS country datasets/Benin/Household_recode_BJHR71SD/BJHR71FL.SAS7BDAT")
dhs_benin_ir<-read_sas("D:/Lenovo data/Healthy diets for Afrika/DHS/DHS country datasets/Benin/Individual_recode_BJIR71SD/BJIR71FL.SAS7BDAT")
rm(pooled)

#Cameroon
dhs_cameroon_kr<-read_sas("D:/Lenovo data/Healthy diets for Afrika/DHS/DHS country datasets/Cameroon/Children_recode_CMKR71SD/CMKR71FL.SAS7BDAT")
dhs_cameroon_hr<-read_sas("D:/Lenovo data/Healthy diets for Afrika/DHS/DHS country datasets/Cameroon/Household_recode_CMHR71SD/CMHR71FL.SAS7BDAT")
dhs_cameroon_ir<-read_sas("D:/Lenovo data/Healthy diets for Afrika/DHS/DHS country datasets/Cameroon/Individual_recode_CMIR71SD/CMIR71FL.SAS7BDAT")
rm(KRiycf)

#Cote d'Ivorie
dhs_cote_kr<-read_sas("D:/Lenovo data/Healthy diets for Afrika/DHS/DHS country datasets/Cote d'Ivoire/2021/Children_recode_CIKR62SD/CIKR81FL.SAS7BDAT")
dhs_cote_hr<-read_sas("D:/Lenovo data/Healthy diets for Afrika/DHS/DHS country datasets/Cote d'Ivoire/2021/Household_recode_CIHR62SD/CIHR81FL.SAS7BDAT")
dhs_cote_ir<-read_sas("D:/Lenovo data/Healthy diets for Afrika/DHS/DHS country datasets/Cote d'Ivoire/2021/Individual_recode_CIIR62SD/CIIR81FL.SAS7BDAT")
dhs_cote_pr<-read_sas("~/Healthy diets for Afrika/DHS/DHS country datasets/Cote d'Ivoire/2021/Household_member_CIPR62SD/CIPR81FL.SAS7BDAT")
rm(tb_benin)

#Ghana
dhs_ghana_kr<-read_sas("D:/Lenovo data/Healthy diets for Afrika/DHS/DHS country datasets/Ghana/2022/Children_recode_GHKR8ASD/GHKR8AFL.SAS7BDAT")
dhs_ghana_hr<-read_sas("D:/Lenovo data/Healthy diets for Afrika/DHS/DHS country datasets/Ghana/2022/Household_recode_GHHR8ASD/GHHR8AFL.SAS7BDAT")
dhs_ghana_ir<-read_sas("D:/Lenovo data/Healthy diets for Afrika/DHS/DHS country datasets/Ghana/2022/Individual_recode_GHIR8ASD/GHIR8AFL.SAS7BDAT")
rm(KRiycf)

#Kenya
dhs_kenya_kr<-read_sas("D:/Lenovo data/Healthy diets for Afrika/DHS/DHS country datasets/Kenya/2022/Children_recode_KEKR8CSD/KEKR8CFL.SAS7BDAT")
dhs_kenya_hr<-read_sas("D:/Lenovo data/Healthy diets for Afrika/DHS/DHS country datasets/Kenya/2022/Household_recode_KEHR8CSD/KEHR8CFL.SAS7BDAT")
dhs_kenya_ir<-read_sas("D:/Lenovo data/Healthy diets for Afrika/DHS/DHS country datasets/Kenya/2022/Individual_recode_KEIR8CSD/KEIR8CFL.SAS7BDAT")
rm(KRiycf)

#Liberia
dhs_liberia_kr<-read_sas("D:/Lenovo data/Healthy diets for Afrika/DHS/DHS country datasets/Liberia/Children_recode_LBKR7ASD/LBKR7AFL.SAS7BDAT")
dhs_liberia_hr<-read_sas("D:/Lenovo data/Healthy diets for Afrika/DHS/DHS country datasets/Liberia/Household_recode_LBHR7ASD/LBHR7AFL.SAS7BDAT")
dhs_liberia_ir<-read_sas("D:/Lenovo data/Healthy diets for Afrika/DHS/DHS country datasets/Liberia/Individual_recode_LBIR7ASD/LBIR7AFL.SAS7BDAT")
rm(denorm)

#Nigeria
dhs_nigeria_kr<-read_sas("D:/Lenovo data/Healthy diets for Afrika/DHS/DHS country datasets/Nigeria/Children_recode_NGKR7BSD/NGKR7BFL.SAS7BDAT")
dhs_nigeria_hr<-read_sas("D:/Lenovo data/Healthy diets for Afrika/DHS/DHS country datasets/Nigeria/Household_recode_NGHR7BSD/NGHR7BFL.SAS7BDAT")
dhs_nigeria_ir<-read_sas("D:/Lenovo data/Healthy diets for Afrika/DHS/DHS country datasets/Nigeria/Individual_recode_NGIR7BSD/NGIR7BFL.SAS7BDAT")
rm(denorm)

#Uganda
dhs_uganda_kr<-read_sas("D:/Lenovo data/Healthy diets for Afrika/DHS/DHS country datasets/Uganda/Children_recode_UGKR7BSD/UGKR7BFL.SAS7BDAT")
dhs_uganda_hr<-read_sas("D:/Lenovo data/Healthy diets for Afrika/DHS/DHS country datasets/Uganda/Household_recode_UGHR7BSD/UGHR7BFL.SAS7BDAT")
dhs_uganda_ir<-read_sas("D:/Lenovo data/Healthy diets for Afrika/DHS/DHS country datasets/Uganda/Individual_recode_UGIR7BSD/UGIR7BFL.SAS7BDAT")
rm(sample)

```

Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.


```{r}

#In the following code block we are first loading the individual country data set that we have created using the rest of the code. After data cleaning, calculation of Planetary health diet index and food group indices we created individual country level data sets containing these variables, sociodemographic variables of interest and sampling and clustering variables. This was done in order to not repeat the primary analysis again and again. This also simplifies further data analysis; for example creating a pooled data of eight countries for country fixed effects analysis.

###Pooled Analysis###
Benin<- read_csv2("E:/Lenovo data/Healthy diets for Afrika/DHS/DHS country datasets/DHS_IYCF_Analysis/tb_Benin.csv")
Cameroon<- read_csv2("E:/Lenovo data/Healthy diets for Afrika/DHS/DHS country datasets/DHS_IYCF_Analysis/tb_Cameroon.csv")
Cote<-read_csv2("E:/Lenovo data/Healthy diets for Afrika/DHS/DHS country datasets/DHS_IYCF_Analysis/tb_Cote_dIvoire.csv")
Ghana<-read_csv2("E:/Lenovo data/Healthy diets for Afrika/DHS/DHS country datasets/DHS_IYCF_Analysis/tb_Ghana.csv")
Kenya<-read_csv2("E:/Lenovo data/Healthy diets for Afrika/DHS/DHS country datasets/DHS_IYCF_Analysis/tb_Kenya.csv")
Liberia<-read_csv2("E:/Lenovo data/Healthy diets for Afrika/DHS/DHS country datasets/DHS_IYCF_Analysis/tb_Liberia.csv")
Nigeria<-read_csv2("E:/Lenovo data/Healthy diets for Afrika/DHS/DHS country datasets/DHS_IYCF_Analysis/tb_Nigeria.csv")
Uganda<-read_csv2("E:/Lenovo data/Healthy diets for Afrika/DHS/DHS country datasets/DHS_IYCF_Analysis/tb_Uganda.csv")
Benin<-Benin %>%mutate(country = "Benin") #add a new variable that adds country name
Benin<-Benin %>%mutate(st_PHI = scale(newPHI)) #standardize the planetary health diet index variable for regression analysis
Benin<-Benin %>%subset(age<6) #create a sub data set for generating exclusively breastfeeding tables
Cameroon<-Cameroon %>%mutate(country = "Cameroon")
Cameroon<-Cameroon %>%mutate(st_PHI = scale(newPHI))
Cameroon<-Cameroon %>%subset(age<6)
Cote<-Cote %>%mutate(country = "Cote")
Cote<-Cote %>%mutate(st_PHI = scale(newPHI))
Cote<-Cote %>%subset(age<6)
Ghana<-Ghana %>%mutate(country = "Ghana")
Ghana<-Ghana %>%mutate(st_PHI = scale(newPHI))
Ghana<-Ghana %>%subset(age<6)
Kenya<-Kenya %>%mutate(country = "Kenya")
Kenya<-Kenya %>%mutate(st_PHI = scale(newPHI))
Kenya<-Kenya %>%subset(age<6)
Liberia<-Liberia %>%mutate(country = "Liberia")
Liberia<-Liberia %>%mutate(st_PHI = scale(newPHI))
Liberia<-Liberia %>%subset(age<6)
Nigeria<-Nigeria %>%mutate(country = "Nigeria")
Nigeria<-Nigeria %>%mutate(st_PHI = scale(newPHI))
Nigeria<-Nigeria %>%subset(age<6)
Uganda<-Uganda %>%mutate(country = "Uganda")
Uganda<-Uganda %>%mutate(st_PHI = scale(newPHI))
Uganda<-Uganda %>%subset(age<6)
rm(pooled)
pooled<-rbind(Benin, Cameroon, Cote, Ghana, Kenya, Liberia, Nigeria, Uganda) #pooled dataset for country fixed effects regression analysis

####Dividing data into quartiles with increasing rank
Benin<-Benin%>%arrange(newPHI)%>%mutate(nquartile=ntile(newPHI,4))
Cameroon<-Cameroon%>%arrange(newPHI)%>%mutate(nquartile=ntile(newPHI,4))
Cote<-Cote%>%arrange(newPHI)%>%mutate(nquartile=ntile(newPHI,4))
Ghana<-Ghana%>%arrange(newPHI)%>%mutate(nquartile=ntile(newPHI,4))
Kenya<-Kenya%>%arrange(newPHI)%>%mutate(nquartile=ntile(newPHI,4))
Liberia<-Liberia%>%arrange(newPHI)%>%mutate(nquartile=ntile(newPHI,4))
Nigeria<-Nigeria%>%arrange(newPHI)%>%mutate(nquartile=ntile(newPHI,4))
Uganda<-Uganda%>%arrange(newPHI)%>%mutate(nquartile=ntile(newPHI,4))


#pooled socio economic and demographic characteristics table 
tb1<-svydesign(ids = ~v021,weights = ~wt ,data = pooled, strata = ~v022, nest = T) #create survey design object first
pool<- tb1%>% tbl_svysummary(by ="country" ,include = c(age,res,wealth,sex,mo_edu,newPHI), type = list(newPHI~"continuous"),statistic = list(all_continuous() ~"{mean} ({sd})",all_categorical() ~ "{n} ({p}%)"), digits = all_continuous() ~ 2, label = c(age~"Age",res~"Residence",wealth~"Wealth Index",sex~"Sex",mo_edu~"Mothers Education", newPHI ~ "PHDI")) %>% add_p() %>% as_gt()%>%gt::gtsave(filename = "pool.docx")

###Country tables (socio demographic characteristics)
tb1<-svydesign(ids = ~v021,weights = ~wt ,data = Uganda, strata = ~v022, nest = T)
NtaUg<- tb1%>% tbl_svysummary(by ="nquartile" ,include = c(age,res,wealth,sex,mo_edu,newPHI), type = list(newPHI~"continuous"),statistic = list(all_continuous() ~"{mean} ({sd})",all_categorical() ~ "{n} ({p}%)"), digits = all_continuous() ~ 2, label = c(age~"Age",res~"Residence",wealth~"Wealth Index",sex~"Sex",mo_edu~"Mothers Education", newPHI ~ "PHDI")) %>% add_p() %>% as_gt()%>%gt::gtsave(filename = "NtaUg.docx")

##combined a nd couzntry level table for food item
food_group<- tb1%>% tbl_svysummary(by ="country" ,include = c(nt_formula,nt_meat,nt_organs,nt_bbyfood,nt_nuts,nt_juice,nt_soup_broth,
                    nt_bread_noodles,nt_vege,nt_dark_green_vege,nt_fruits,nt_other_fruits,nt_milk,nt_dairy,nt_yogurt,
                    nt_root,nt_eggs,nt_fish),
                    statistic = list(all_continuous() ~"{mean} ({sd})",all_categorical() ~ "{n} ({p}%)"), digits = all_continuous() ~ 2,                     label = c(nt_formula~"Formula",nt_meat~"Meat",nt_organs~"Organs",nt_bbyfood~"Baby Food",nt_nuts~"Nuts & Lentils",
                    nt_juice ~ "Juice",nt_soup_broth~"Soup & Broth", nt_bread_noodles ~ "Bread & Noodles",nt_vege ~ "Vegetables",
                    nt_dark_green_vege ~ "Dark Green Vegetables", nt_fruits ~ "Fruits", nt_other_fruits ~ "Other Fruits",
                    nt_milk ~ "Milk", nt_dairy ~ "Dairy", nt_yogurt ~ "Yogurt", nt_root ~ " Roots & Tubers", nt_eggs ~ "Eggs", 
                    nt_fish ~ "Fish")) %>% add_p() %>% as_gt()%>%gt::gtsave(filename = "food_groups.docx")

food_group_quartile<- tb1%>% tbl_svysummary(by ="nquartile" ,include = c(nt_formula,nt_meat,nt_organs,nt_bbyfood,nt_nuts,nt_juice,nt_soup_broth,
                    nt_bread_noodles,nt_vege,nt_dark_green_vege,nt_fruits,nt_other_fruits,nt_milk,nt_dairy,nt_yogurt,
                    nt_root,nt_eggs,nt_fish),
                    statistic = list(all_continuous() ~"{mean} ({sd})",all_categorical() ~ "{n} ({p}%)"), digits = all_continuous() ~ 2,                     label = c(nt_formula~"Formula",nt_meat~"Meat",nt_organs~"Organs",nt_bbyfood~"Baby Food",nt_nuts~"Nuts & Lentils",
                    nt_juice ~ "Juice",nt_soup_broth~"Soup & Broth", nt_bread_noodles ~ "Bread & Noodles",nt_vege ~ "Vegetables",
                    nt_dark_green_vege ~ "Dark Green Vegetables", nt_fruits ~ "Fruits", nt_other_fruits ~ "Other Fruits",
                    nt_milk ~ "Milk", nt_dairy ~ "Dairy", nt_yogurt ~ "Yogurt", nt_root ~ " Roots & Tubers", nt_eggs ~ "Eggs", 
                    nt_fish ~ "Fish")) %>% add_p() %>% as_gt()%>%gt::gtsave(filename = "food_groups_quartile.docx")

tb1<-svydesign(ids = ~v021,weights = ~wt ,data = Uganda , strata = ~v022, nest = T)
food_group_uganda<- tb1%>% tbl_svysummary(by ="nquartile" ,include = c(nt_formula,nt_meat,nt_organs,nt_bbyfood,nt_nuts,nt_juice,nt_soup_broth,
                    nt_bread_noodles,nt_vege,nt_dark_green_vege,nt_fruits,nt_other_fruits,nt_milk,nt_dairy,nt_yogurt,
                    nt_root,nt_eggs,nt_fish),
                    statistic = list(all_continuous() ~"{mean} ({sd})",all_categorical() ~ "{n} ({p}%)"), digits = all_continuous() ~ 2,                     label = c(nt_formula~"Formula",nt_meat~"Meat",nt_organs~"Organs",nt_bbyfood~"Baby Food", 
                    nt_nuts~"Nuts & Lentils",
                    nt_juice ~ "Juice",nt_soup_broth~"Soup & Broth", nt_bread_noodles ~ "Bread & Noodles",nt_vege ~ "Vegetables",
                    nt_dark_green_vege ~ "Dark Green Vegetables", nt_fruits ~ "Fruits", nt_other_fruits ~ "Other Fruits",
                    nt_milk ~ "Milk", nt_dairy ~ "Dairy", nt_yogurt ~ "Yogurt", nt_root ~ " Roots & Tubers", nt_eggs ~ "Eggs", 
                    nt_fish ~ "Fish")) %>% add_p() %>% as_gt()%>%gt::gtsave(filename = "food_groups_uganda.docx")

###for countries without babyfood variable
food_group_kenya<- tb1%>% tbl_svysummary(by ="nquartile" ,include = c(nt_formula,nt_meat,nt_organs,nt_nuts,nt_juice,nt_soup_broth,
                    nt_bread_noodles,nt_vege,nt_dark_green_vege,nt_fruits,nt_other_fruits,nt_milk,nt_dairy,nt_yogurt,
                    nt_root,nt_eggs,nt_fish),
                    statistic = list(all_continuous() ~"{mean} ({sd})",all_categorical() ~ "{n} ({p}%)"), digits = all_continuous() ~ 2,                     label = c(nt_formula~"Formula",nt_meat~"Meat",nt_organs~"Organs", nt_nuts~"Nuts & Lentils",
                    nt_juice ~ "Juice",nt_soup_broth~"Soup & Broth", nt_bread_noodles ~ "Bread & Noodles",nt_vege ~ "Vegetables",
                    nt_dark_green_vege ~ "Dark Green Vegetables", nt_fruits ~ "Fruits", nt_other_fruits ~ "Other Fruits",
                    nt_milk ~ "Milk", nt_dairy ~ "Dairy", nt_yogurt ~ "Yogurt", nt_root ~ " Roots & Tubers", nt_eggs ~ "Eggs", 
                    nt_fish ~ "Fish")) %>% add_p() %>% as_gt()%>%gt::gtsave(filename = "food_groups_kenya.docx")


####table for proportion of children satisfyinf food group indices in each quartile of planetary health diet index
tb_data$nt_mad<-as.factor(tb_data$nt_mad) #just to make sure it categorical variable
tb_data$nt_mmf<-as.factor(tb_data$nt_mmf)
tb_data$nt_mdd<-as.factor(tb_data$nt_mdd)
tb1<-svydesign(ids = ~v021,weights = ~wt ,data = Uganda, strata = ~v022, nest = T)
FGIUg<- tb1%>% tbl_svysummary(by ="nquartile" ,include =   c(nt_mad,nt_mdd,nt_mmf),statistic = list(all_categorical() ~ "{n} ({p}%)"), label = c(nt_mmf~"Minimum meal frequency",nt_mdd~"Minimum dietary diversity",nt_mad~"Minimum acceptable diet"), missing_text = "NA", missing_stat = "{N_miss}") %>% add_p() %>% as_gt()%>%gt::gtsave(filename = "FGIUg.docx")

#Preparing tables for children aged 0-5 who are /are not exclusively breastfed
EBF<-subset(Benin, !is.na(nt_ebf))
eb1<-svydesign(ids = ~v021,weights = ~wt ,data = Benin, strata = ~v022, nest = T)


Eb_Be<-eb1%>% tbl_svysummary(by ="nt_ebf" ,include = c(age,res,wealth,sex,mo_edu,newPHI), type = list(newPHI~"continuous", age ~ "continuous"),statistic = list(all_continuous() ~"{mean} ({sd})",all_categorical() ~ "{n} ({p}%)"), digits = all_continuous() ~ 2, label = c(age~"Age",res~"Residence",wealth~"Wealth Index",sex~"Sex",mo_edu~"Mothers Education", newPHI ~ "PHDI")) %>% add_p() %>% as_gt()%>%gt::gtsave(filename = "Eb_Be.docx")


#area plots for distribution of PHDI across age groups
font_import() #it is possible that you might need to run this in order the install fonts needed for the areaplot
loadfonts(device = "win")

Uganda$nquartile<-as.factor(Uganda$nquartile)
plot1<-Uganda%>%group_by(nquartile,age)%>%
        dplyr::summarise(n=n())%>%mutate(percentage = n/sum(n)*100)

ggplot(plot1, aes(x=age, y = percentage, fill = nquartile)) + 
    geom_area(alpha=0.6 , size=1, colour="white") + theme_ipsum()+scale_fill_viridis(discrete = T, labels=c("Quartile 1", "Quartile 2",      "Quartile 3", "Quartile 4"))+ ggtitle("Proportion of children in each Quartile of PHI Index: Nigeria")+xlab("Age of child in months")             + ylab("Percentage") + guides(fill = guide_legend("Quartiles")) + 
      scale_x_continuous(breaks = c(0,2,4,6, 8, 10, 12, 14, 16, 18, 20, 22,24),
                       labels = c("0 mo","2 mo", "4 mo",  "6 mo", "8 mo", "10 mo", "12 mo", "14 mo", "16 mo", "18 mo", "20 mo", 
                                  "22 mo","24")) + theme(axis.title.x = element_text(hjust=0.5, size =10), axis.title.y =                                 element_text(hjust=0.5, size =10))
```

```{r}
#matching the ids of mothers from IR file with kids from KR file to make sure there is no duplication

#The reason for doing this not only to avoid duplication, it is important to understand that the IR file collects information on all mothers and the KR file collects information on children under five years of age in a household from the mother (same case ID). In the KR file DHS collects data on diversity of food groups consumed for children aged between 0 - 23 months. In the data cleaning process for KR file, we select youngest child alive under two years of age to calculate planetary health diet index. For the pooled analysis we cannot use the normalized weights that DHS provides for each country data sets. We have to denormalize the weights.But direct denormalization in the KR file would be wrong because it excludes all the women who did not have children, and since women were the ones who were interviewed for the their children, denormlaization has to first happen in the IR file to get actual estimate of the population. After that you match the ids with the cleaned data set which you created for children aged 0-23 months and thus you have the denormalized weights for the children (mother's interviewed) in your data set. 

names(dhs_benin_ir)<-tolower(names(dhs_benin_ir))
dhs_benin_ir <- dhs_benin_ir %>%
  mutate(wt = v005/1000000)
matching_ids <- KRdata$caseid[KRdata$caseid %in% dhs_benin_ir$CASEID] #find out how many matching ids are there between IR and KR file
dhs_benin_ir<-dhs_benin_ir%>%mutate(denorm = wt * (2717666/15928)) #denormalize the weights in IR file

#Add the denormalized weight variable to KRiycf file by matching ids between IR and KRiycf
KRiycf<-left_join(KRiycf,dhs_benin_ir,by=c("caseid"="caseid")) 

tb_benin<-KRiycf[,c(1,26:28,1192:1255)] #select variables from the KRiycf file that you need for further analysis 

#Repeat the same process for every country and generate a csv dataset for each of them for further analysis
write.csv2(tb_benin,"D:/Lenovo data/Healthy diets for Afrika/DHS/DHS country datasets/DHS_IYCF_Analysis/tb_benin.csv")
```



```{r}
#rename ids

dhs_benin_hr <- dhs_benin_hr %>%
  mutate(V001=HV001) %>%
  mutate(V002=HV002) 

# keep relevant vars
HRtemp =subset(dhs_benin_hr, select=c(V001, V002, HV234A,HV025,HV271))


#perform merge
KRdata <- merge(dhs_benin_kr,HRtemp,by=c("V001", "V002"))

#remove temporary file used for left_join
rm(HRtemp)

names(KRdata)<-tolower(names(KRdata))

```

```{r}
# Calculate age of child. If b19 is not available in the data use v008 - b3
if ("TRUE" %in% (!("b19" %in% names(KRdata))))
  KRdata [[paste("b19")]] <- NA
if ("TRUE" %in% all(is.na(KRdata$b19)))
{ b19_included <- 0} else { b19_included <- 1}

if (b19_included==1) {
  KRdata <- KRdata %>%
    mutate(age = b19)
} else {
  KRdata <- KRdata %>%
    mutate(age = v008 - b3)
}

```

```{r}

#create subset of KRfile to select for children for IYCF indicators
#Following code is no longer working for selecting youngest child
#KRiycf <- KRdata %>%
  #subset(age < 24 & b9==0 & !is.na(b9)) %>% # children under 24 months living at home
  #arrange(caseid, bidx) #%>% # make sure the data is sorted
  #subset(is.na(lag(caseid)) | caseid!=lag(caseid)) # select just the youngest

##solution 1
KRiycf<-KRdata%>%subset(age < 24 & b9 == 0) %>% arrange(caseid,bidx)%>%
          slice_min(by = caseid, order_by = bidx)

#solution 2
KRiycf <- KRdata %>%
  subset(age < 24 & b9 == 0) %>%  # Keep children under 24 months living at home (b9 == 0)
  arrange(caseid, bidx) %>%       # Sort data by 'caseid' (mother) and 'bidx' (child index)
  distinct(caseid, .keep_all = TRUE) #ensures that only the youngest child for each mother is selected

KRiycf<-KRiycf[, c(3,2,1,4:ncol(KRiycf))] #rearrage the columns to make sure caseid is the first column
```

```{r}
#divide the weight variable by 1000000 to 
KRiycf <- KRiycf %>%
  mutate(wt = v005/1000000)

# //currently breastfed

KRiycf <- KRiycf %>%
  mutate(nt_bf_curr =
           case_when(
              m4==95  ~ 1 ,
              m4 %in% c(93,94,98,99) ~ 0)) %>%
  set_value_labels(nt_bf_curr = c("Yes" = 1, "No"=0  )) %>%
  set_variable_labels(nt_bf_curr = "Currently breastfeeding - last-born under 2 years")

```


```{r}
# *** Breastfeeding and complemenatry feeding ***
# 
# //currently breastfed

KRiycf <- KRiycf %>%
  mutate(water  = case_when(v409==1  ~ 1 , v409!=1 ~ 0)) %>%
  mutate(liquids= case_when(v409a==1 | v410==1 | v410a==1 | v412c==1 | v413==1 | v413a==1 | v413b==1 | v413c==1 | v413d==1  ~ 1 , 
                            v409a!=1 | v410!=1 | v410a!=1 | v412c!=1 | v413!=1 | v413a!=1 | v413b!=1 | v413c!=1 | v413d!=1 ~ 0)) %>%
  mutate(milk   = case_when(v411==1 | v411a==1 ~ 1 , v411!=1 | v411a!=1 ~ 0)) %>%
  mutate(solids = case_when(v414a==1 | v414b==1 | v414c==1 | v414d==1 | v414e==1 | v414f==1 | v414g==1 | v414h==1 | v414i==1 | 
                            v414j==1 | v414k==1 | v414l==1 | v414m==1 | v414n==1 | v414o==1 | v414p==1 | v414q==1 | v414r==1 | 
                            v414s==1 | v414t==1 | v414u==1 | v414v==1 | v414w==1 | v412a==1 | v412b==1 | m39a==1 ~ 1 ,
                            v414a!=1 | v414b!=1 | v414c!=1 | v414d!=1 | v414e!=1 | v414f!=1 | v414g!=1 | v414h!=1 | v414i!=1 | 
                            v414j!=1 | v414k!=1 | v414l!=1 | v414m!=1 | v414n!=1 | v414o!=1 | v414p!=1 | v414q!=1 | v414r!=1 | 
                            v414s!=1 | v414t!=1 | v414u!=1 | v414v!=1 | v414w!=1 | v412a!=1 | v412b!=1 | m39a!=1~ 0) ) %>%
  mutate(nt_bf_status = case_when(nt_bf_curr==0 ~ 0, solids==1 ~ 5, milk==1 ~ 4, liquids==1 ~3, water==1 ~2, TRUE~1 )) %>%
  set_value_labels(nt_bf_status = c("not bf"=0, "exclusively bf"=1, "bf & plain water"=2, "bf & non-milk liquids"=3, "bf & other milk"=4, "bf & complemenatry foods"=5 )) %>%
  set_variable_labels(nt_bf_status = "Breastfeeding status for last-born child under 2 years")

```

```{r}
# //exclusively breastfed
KRiycf <- KRiycf %>%
  mutate(nt_ebf =
           case_when(
             age<6 & nt_bf_status==1  ~ 1 ,
             age<6 & nt_bf_status!=1 ~ 0)) %>%
  set_value_labels(nt_ebf = c("Yes" = 1, "No"=0  )) %>%
  set_variable_labels(nt_ebf = "Exclusively breastfed - last-born under 6 months")
```

```{r}
# //predominantly breastfeeding

KRiycf <- KRiycf %>%
  mutate(nt_predo_bf =
           case_when(
             age<6 & nt_bf_status %in%c(1,2,3)  ~ 1 ,
             age<6 & nt_bf_status %in%c(0,4,5)  ~ 0)) %>%
  set_value_labels(nt_predo_bf = c("Yes" = 1, "No"=0  )) %>%
  set_variable_labels(nt_predo_bf = "Predominantly breastfed - last-born under 6 months")
```

```{r}
# //age appropriate breastfeeding
library(data.table)
KRiycf <- KRiycf %>%
  mutate(nt_ageapp_bf =
           case_when(
             nt_ebf==1 | nt_bf_status==5 & inrange(age,6,23)  ~ 1,
             TRUE ~ 0 )) %>%
  set_value_labels(nt_ageapp_bf = c("Yes" = 1, "No"=0  )) %>%
  set_variable_labels(nt_ageapp_bf = "Age-appropriately breastfed - last-born under 2 years")
```

```{r}
# //continuing breastfeeding at 1 year

KRiycf <- KRiycf %>%
  mutate(nt_food_bf =
           case_when(
             solids==1 & inrange(age,6,8)  ~ 1,
             solids==0 & inrange(age,6,8) ~ 0 )) %>%
  set_value_labels(nt_food_bf = c("Yes" = 1, "No"=0  )) %>%
  set_variable_labels(nt_food_bf = "Introduced to solid, semi-solid, or soft foods - last-born 6-8 months")

# //continuing breastfeeding at 1 year
KRiycf <- KRiycf %>%
  mutate(nt_bf_cont_1yr =
           case_when(
             m4==95 & inrange(age,12,15)  ~ 1,
             m4!=95 & inrange(age,12,15) ~ 0 )) %>%
  set_value_labels(nt_bf_cont_1yr = c("Yes" = 1, "No"=0  )) %>%
  set_variable_labels(nt_bf_cont_1yr = "Continuing breastfeeding at 1 year (12-15 months) - last-born under 2 years")
```

```{r}
# //continuing breastfeeding at 2 years
KRiycf <- KRiycf %>%
  mutate(nt_bf_cont_2yr =
           case_when(
             m4==95 & inrange(age,20,23)  ~ 1,
             m4!=95 & inrange(age,20,23) ~ 0 )) %>%
  set_value_labels(nt_bf_cont_2yr = c("Yes" = 1, "No"=0  )) %>%
  set_variable_labels(nt_bf_cont_2yr = "Continuing breastfeeding at 2 year (20-23 months) - last-born under 2 years")
```

```{r}
# *** Foods consumed ***
KRiycf <- KRiycf %>%
  # country specific foods. These can be added to the foods below based on the survey. See example for nt_root & nt_meatfish below
  mutate(food1  = case_when(v414a==1  ~ 1 , v414a!=1 ~ 0)) %>%
  mutate(food2  = case_when(v414b==1  ~ 1 , v414a!=1 ~ 0)) %>%
  mutate(food3  = case_when(v414c==1  ~ 1 , v414a!=1 ~ 0)) %>%
  mutate(food4  = case_when(v414d==1  ~ 1 , v414a!=1 ~ 0)) %>%
  mutate(nt_formula  = case_when(v411a==1  ~ -1 , v411a!=1~ 0)) %>% # Given formula
  mutate(nt_meat= case_when((v000 == "UG7" & (v414h==1 | food2==1)) | (v000 != "UG7" & (v414h==1)) ~ -1, 
    (v000 == "UG7" & !(v414h==1 | food2==1)) | (v000 != "UG7" & !(v414h==1)) ~ 0))%>%
  mutate(nt_organs= case_when((v000 == "UG7" & (v414m==1 | food2==1)) | (v000 != "UG7" & (v414m==1)) ~ -1, 
    (v000 == "UG7" & !(v414m==1 | food2==1)) | (v000 != "UG7" & !(v414m==1)) ~ 0))%>%
  mutate(nt_bbyfood  = case_when(v412a==1  ~ -1 , v412a!=1~ 0)) %>% # Given fortified baby food
  mutate(nt_nuts  = case_when(v414o==1  ~ 1 , v414o!=1~ 0)) %>% # Given nuts or legumes

  #add labels
  set_value_labels(nt_formula = c("Yes" = -1, "No"=0  )) %>%
  set_variable_labels(nt_formula = "Child given infant formula in day/night before survey - last-born under 2 years") %>%
  set_value_labels(nt_meat = c("Yes" = -1, "No"=0  )) %>%
  set_variable_labels(nt_meat = "Child given meat in the day/night before survey- last-born under 2 years")%>%
  set_value_labels(nt_organs = c("Yes" = -1, "No"=0  )) %>%
  set_variable_labels(nt_organs = "Child given organs in the day/night before survey- last-born under 2 years")%>% 
  set_value_labels(nt_bbyfood = c("Yes" = -1, "No"=0  )) %>%
  set_variable_labels(nt_bbyfood = "Child given fortified baby food in day/night before survey- last-born under 2 years") %>%
  set_value_labels(nt_nuts = c("Yes" = 1, "No"=0  )) %>%
  set_variable_labels(nt_nuts = "Child given legumes or nuts in day/night before survey- last-born under 2 years") 
```

```{r}
##Foods consumed continued
KRiycf<-KRiycf%>%
  mutate(food1 = case_when(v414a==1 ~ 1, v414a != 1 ~ 0))%>%
  mutate(food2 = case_when(v414b==1 ~ 1, v414b != 1 ~ 0))%>%
  mutate(food3 = case_when(v414c==1 ~ 1, v414c !=1 ~ 0))%>%
  mutate(food4 = case_when(v414d==1 ~ 1, v414d !=1 ~ 0))%>%
  mutate(nt_juice = case_when(v410 == 1 ~ 1, v410 != 1 ~ 0)) %>%
  mutate(nt_soup_broth = case_when(v412c == 1 ~ 1, v412c != 1 ~ 0))%>%
  mutate(nt_bread_noodles = case_when(v414e == 1 ~ 1, v414e != 1 ~ 0))%>%
  mutate(nt_vege = case_when(v414i == 1 ~ 1, v414i != 1 ~ 0))%>%
  mutate(nt_dark_green_vege = case_when(v414j == 1 ~ 1, v414j != 1 ~ 0))%>%
  mutate(nt_fruits = case_when(v414k == 1 ~ 1, v414k != 1 ~ 0))%>%
  mutate(nt_other_fruits = case_when(v414l == 1 ~ 1, v414l != 1 ~ 0))%>%
  mutate(nt_milk  = case_when(v411==1  ~ 1 , v411!=1~ 0)) %>% # Given other milk
  mutate(nt_dairy = case_when(v414p == 1 ~ 1, v414p!= 1 ~ 0))%>%
  mutate(nt_yogurt = case_when(v414v == 1 ~ 1, v414v!= 1 ~ 0))%>%
  mutate(nt_root  = case_when((v000 == "UG7" & (v414f==1 | food1==1)) | (v000 != "UG7" & v414f==1) ~ 1, 
    (v000 == "UG7" & (v414f!=1 | food1!=1)) | (v000 != "UG7" & v414f!=1) ~ 0)) %>% #given roots and tubers
  mutate(nt_eggs  = case_when(v414g==1  ~ 1 , v414g!=1~ 0)) %>% #given eggs
  
  
  #set labels
  set_value_labels(nt_juice = c("Yes" = 1, "No"=0  )) %>%
  set_variable_labels(nt_juice = "Child given juice in the day/night before survey- last-born under 2 years")%>%
  set_value_labels(nt_soup_broth = c("Yes" = 1, "No"=0  )) %>%
  set_variable_labels(nt_soup_broth = "Child given soup/broth in the day/night before survey- last-born under 2 years")%>%
  set_value_labels(nt_bread_noodles = c("Yes" = 1, "No"=0  )) %>%
  set_variable_labels(nt_bread_noodles = "Child given bread/noodles in the day/night before survey- last-born under 2 years")%>%
  set_value_labels(nt_vege = c("Yes" = 1, "No"=0  )) %>%
  set_variable_labels(nt_vege = "Child given vegetables in the day/night before survey- last-born under 2 years")%>%
  set_value_labels(nt_dark_green_vege = c("Yes" = 1, "No"=0  )) %>%
  set_variable_labels(nt_dark_green_vege = "Child given dark green vegetables in the day/night before survey- last-born under 2 years")%>%
  set_value_labels(nt_fruits = c("Yes" = 1, "No"=0  )) %>%
  set_variable_labels(nt_fruits = "Child given Vit A rich fruits in the day/night before survey- last-born under 2 years")%>% 
  set_value_labels(nt_other_fruits = c("Yes" = 1, "No"=0  )) %>%
  set_variable_labels(nt_other_fruits = "Child given other fruits in the day/night before survey- last-born under 2 years")%>%
  set_value_labels(nt_milk = c("Yes" = 1, "No"=0  )) %>%
  set_variable_labels(nt_milk = "Child given other milk in day/night before survey- last-born under 2 years") %>%
  set_value_labels(nt_dairy = c("Yes" = 1, "No"=0  )) %>%
  set_variable_labels(nt_dairy = "Child given dairy in the day/night before survey- last-born under 2 years")%>% 
  set_value_labels(nt_yogurt = c("Yes" = 1, "No"=0  )) %>%
  set_variable_labels(nt_yogurt = "Child given yogurt in the day/night before survey- last-born under 2 years")%>%
  set_value_labels(nt_root = c("Yes" = 1, "No"=0  )) %>%
  set_variable_labels(nt_root = "Child given roots or tubers in day/night before survey- last-born under 2 years")%>%
  set_value_labels(nt_eggs = c("Yes" = 1, "No"=0  )) %>%
  set_variable_labels(nt_eggs = "Child given eggs in day/night before survey- last-born under 2 years")
```


```{r}
#Consumed fish or not
KRiycf<- KRiycf %>%
  mutate(food1  = case_when(v414a==1  ~ 1 , v414a!=1 ~ 0)) %>%
  mutate(food2  = case_when(v414b==1  ~ 1 , v414a!=1 ~ 0)) %>%
  mutate(food3  = case_when(v414c==1  ~ 1 , v414a!=1 ~ 0)) %>%
  mutate(food4  = case_when(v414d==1  ~ 1 , v414a!=1 ~ 0)) %>%
  mutate(nt_fish= case_when((v000 == "UG7" & (v414n==1 | food2==1)) | (v000 != "UG7" & (v414n==1)) ~ 1, 
    (v000 == "UG7" & !(v414n==1 | food2==1)) | (v000 != "UG7" & !(v414n==1)) ~ 0))%>%
  set_value_labels(nt_fish = c("Yes" = 1, "No"=0  )) %>%
  set_variable_labels(nt_fish = "Child given dish or shellfish in day/night before survey- last-born under 2 years")

table(KRiycf$newPHI, useNA = "always")

#calculation of planetary health diet index

KRiycf$PHI<-rowSums(KRiycf[,c(1210:1227)], na.rm = T) 

KRiycf$opti_comp<-rowSums(KRiycf[,c(1222:1227)], na.rm = T)

KRiycf$newPHI<-KRiycf$PHI- KRiycf$opti_comp

#Quartiles created based on Planetary health diet index
qqn<-quantile(KRiycf$newPHI, probs = c(0, 0.25, 0.50, 0.75, 1), na.rm= TRUE) 
print(qqn)

KRiycf<-KRiycf%>%mutate(Quartile = case_when(newPHI <0 ~ "Quartile 1", newPHI == 0 ~ "Quartile 2", newPHI == 1 ~ "Quartile 3", newPHI>=2 ~ "Quartile 4"))

KRiycf<-KRiycf%>%mutate(Quartile = case_when(newPHI <1 ~ "Quartile 1", newPHI == 0 | newPHI ==1 ~ "Quartile 2", newPHI == 2 ~ "Quartile 3", newPHI>=3 ~ "Quartile 4"))
KRiycf$Quartile<-as.factor(KRiycf$Quartile)

#Equal quartiles irrespective of rank 
KRiycf <- KRiycf %>%
  mutate(quartile = cut(seq_along(rownames(KRiycf)),  # Create sequence along rows of the dataframe
    breaks = quantile(seq_along(rownames(KRiycf)), probs = seq(0, 1, by = 0.25), na.rm = TRUE),  # Calculate quartile breaks
    include.lowest = TRUE,  # Include lowest value in Q1
    labels = c("Q1", "Q2", "Q3", "Q4")  # Label the quartiles
  ))


KRiycf<-KRiycf%>%mutate(wealth=hv271/100000) #calculate weath index 
KRiycf<-KRiycf%>%mutate(mo_edu=case_when(v106==0~"No education",v106==1~"Primary education",v106==2~"Secondary education",v106==3~"Higher education")) # reconde the education variable 
KRiycf$mo_edu<-as.factor(KRiycf$mo_edu)
KRiycf<-KRiycf%>%mutate(sex=case_when(b4==1~"Boy", b4==2~"Girl")) #recode the sex variable
KRiycf$sex<-as.factor(KRiycf$sex)
KRiycf<-KRiycf%>%mutate(res=case_when(v025==1~"Urban", v025==2~"Rural")) #recode the residence varialbe
KRiycf$res<-as.factor(KRiycf$res)


Eb_Beu6<-eb1%>% tbl_svysummary( by = "nt_ebf",include = c(newPHI), type = list(newPHI~"continuous"),statistic = list(all_continuous() ~"{mean} ({sd})",all_categorical() ~ "{n} ({p}%)"), digits = all_continuous() ~ 2, label = c(newPHI ~ "Planetary Health Diet Index")) %>% add_p() %>% as_gt()%>%gt::gtsave(filename = "Eb_Beu6.docx")

###Regression analysis
model <- svyglm(st_PHI ~ age+ sex + wealth + res + mo_edu, design = Benin, family = gaussian())
summary(model)
msummary(model)

Reg_taug <- model %>%
  tbl_regression(intercept = T,
                 estimate_fun = function(x) style_sigfig(x, digits = 3),
                 pvalue_fun   = function(x) style_pvalue(x, digits = 3),
                 label  = list(age ~ "Age (months)",
                               wealth   ~ "Wealth Index",
                               res ~ "Residence",
                               mo_edu ~ "Mothers' Education",
                               sex   ~ "Sex")) %>%
  add_global_p(keep = T, test.statistic = "F"
  # Uncomment to use design df for Type III test p-values
  # (but then they will not match the regression term p-values for
  #  binary predictors)
  #             , error.df = degf(fit.ex8.1$survey.design)
                                 ) %>%
modify_caption("Association of planetary health diet index with socio demographic and economic characteristics (Weighted Linear Regression") %>% as_gt()%>%gt::gtsave(filename = "Reg_taug.docx")

```

```{r}
# //Fed milk or milk products
KRiycf <- KRiycf %>%
  mutate(v469e_ = v469e) %>%
  replace_with_na(replace = list(v469e_ = c(8)))%>%
  mutate(v469f_ = v469f) %>%
  replace_with_na(replace = list(v469f_ = c(8)))%>%
  mutate(v469x_ = v469x) %>%
  replace_with_na(replace = list(v469x_ = c(8)))%>%
  mutate(v469e_ = coalesce(v469e_, 0),
         v469f_ = coalesce(v469f_, 0),
         v469x_ = coalesce(v469x_, 0))%>%
  mutate(totmilkf= v469e_ + v469f_ + v469x_) %>%
  mutate(nt_fed_milk  = 
           case_when(totmilkf>=2 | m4==95 & inrange(age,6,23) ~ 1 , 
                     totmilkf <2 | m4!=95 & inrange(age,6,23) ~ 0)) %>%
  set_value_labels(nt_fed_milk = c("Yes" = 1, "No"=0  )) %>%
  set_variable_labels(nt_fed_milk = "Child given milk or milk products- last-born 6-23 months")
```

```{r}

# //Min dietary diversity
KRiycf <- KRiycf %>%
  # 1. breastmilk
  mutate(group1 = case_when(m4==95  ~ 1 ,  m4!=95 ~ 0)) %>% 
  #2. infant formula, milk other than breast milk, cheese or yogurt or other milk products
  mutate(group2 = case_when(nt_formula==1 | nt_milk==1 | nt_dairy==1  ~ 1 , nt_formula!=1 | nt_milk!=1 | nt_dairy!=1 ~ 0)) %>%
  #3. foods made from grains, roots, tubers, and bananas/plantains, including porridge and fortified baby food from grains
  mutate(group3  = case_when(nt_bread_noodles==1 | nt_root==1 | nt_bbyfood==1 ~ 1 , nt_bread_noodles!=1 | nt_root!=1 | nt_bbyfood!=1 ~ 0)) %>%
  #4. vitamin A-rich fruits and vegetables
  mutate(group4  = case_when(nt_fruits==1  ~ 1 , nt_fruits!=1 ~ 0)) %>%
  #5. other fruits and vegetables
  mutate(group5  = case_when(nt_vege==1 ~ 1 , nt_vege!=1~ 0)) %>% 
  #6. eggs
  mutate(group6  = case_when(nt_eggs==1 ~ 1 , nt_eggs!=1~ 0)) %>% 
  #7. meat, poultry, fish, and shellfish (and organ meats)
  mutate(group7  = case_when(nt_meat==1 |nt_organs==1| nt_fish==1 ~ 1 , nt_meat!=1| nt_organs!=1| nt_fish!=1~ 0)) %>% 
  #8. legumes and nuts
  mutate(group8  = case_when(nt_nuts==1 ~ 1 , nt_nuts!=1~ 0)) %>% 
  #add the food groups
  mutate(foodsum  = group1+group2+group3+group4+group5+group6+group7+group8) %>% 
  mutate(nt_mdd  = case_when(inrange(age,6,23) & foodsum<5 ~ 0 , inrange(age,6,23) & foodsum>=5~ 1)) %>% 
  #older surveys are 4 out of 7 food groups so the foodsum would add group2-group8 and the recode the sum for 4+ as yes
  set_value_labels(nt_mdd = c("Yes" = 1, "No"=0  )) %>%
  set_variable_labels(nt_mdd = "Child with minimum dietary diversity, 5 out of 8 food groups- last-born 6-23 months")
```

```{r}
# //Min meal frequency
KRiycf <- KRiycf %>%
  mutate(feedings = case_when(m39>0 & m39<8 ~ totmilkf + m39 )) %>%
  mutate(nt_mmf  = 
           if_else(inrange(age,6,23) & (m4==95 & inrange(m39,2,7) & inrange(age,6,8)) | (m4==95 & inrange(m39,3,7) & inrange(age,9,23)) |
                  (m4!=95 & feedings>=4 & inrange(age,6,23)), 1, 0 )) 
KRiycf[["nt_mmf"]] <- ifelse(KRiycf[["age"]]<6, NA, KRiycf[["nt_mmf"]])
KRiycf <- KRiycf %>%
  set_value_labels(nt_mmf = c("Yes" = 1, "No"=0  )) %>%
  set_variable_labels(nt_mmf = "Child with minimum meal frequency- last-born 6-23 months")

```

```{r}

# //Min acceptable diet
KRiycf <- KRiycf %>%
  mutate(foodsum2 = nt_bread_noodles+nt_bbyfood+nt_root+nt_nuts+nt_meat+nt_fish+nt_organs+nt_vege+nt_fruits+nt_dark_green_vege+nt_other_fruits+nt_eggs) %>%
  mutate(nt_mad  = 
           if_else((m4==95 & nt_mdd==1 & nt_mmf==1) | (m4!=95 & foodsum2>=4 & nt_mmf==1 & totmilkf>=2), 1, 0 )) 
KRiycf[["nt_mad"]] <- ifelse(KRiycf[["age"]]<6, NA, KRiycf[["nt_mad"]])
KRiycf <- KRiycf %>%
  set_value_labels(nt_mad = c("Yes" = 1, "No"=0  )) %>%
  set_variable_labels(nt_mad = "Child with minimum acceptable diet- last-born 6-23 months")

```



```{r}
##Correlation analysis 
selected_vars <- KRiycf[, c(1180,1199,1201,1203)] # Replace with your variables
  
# Calculate the weighted correlation matrix
weighted_cor_matrix <- wtd.cor(selected_vars, weight = KRiycf$wt)
wtd.cor(selected_vars$newPHI,selected_vars$nt_mmf)
# The result is a list; we extract the correlation matrix
cor_matrix <- weighted_cor_matrix$correlation
rownames(cor_matrix)<-c("Planetary health diet index","Minimum dietary diversity","Minimum meal frequency","Minimum acceptable diet")
colnames(cor_matrix)<-c("Planetary health diet index","Minimum dietary diversity","Minimum meal frequency","Minimum acceptable diet")

# Plotting the correlation matrix using corrplot
corrplot(cor_matrix, method = "shade", 
         tl.col = "black", tl.cex = 0.8, number.cex = 0.7,tl.pos = 'ld' ,
         addCoef.col = "black", # Add correlation coefficient on the plot
         order = "hclust", # Order by hierarchical clustering
         col = colorRampPalette(c("red", "white", "blue"))(200), type='lower',tl.srt = 45, mar = c(1,1,2,1))

```



```{r}
##Regression Plots

# Create a new data frame for predictions
#wealth
new_data <- expand.grid(
  wealth = seq(min(tb_data$wealth), max(tb_data$wealth), length.out = 1000),
  age = mean(tb_data$age),
  res = levels(factor(tb_data$res)),  # Adjust as needed
  mo_edu = levels(factor(tb_data$mo_edu))   # Adjust as needed
)

# Add predictions to the new data frame
new_data$predicted_outcome <- predict(model, newdata = new_data, type = "response")

p1<-ggplot(new_data, aes(x = age, y = predicted_outcome, color = res)) +
  geom_smooth() +
  labs(x = "Age (Months)",
       y = "Predicted Planetary Health Diet Index",
    color = "Residence"
  ) +
  theme_minimal()+ theme(plot.margin = margin(10,10,30,10))



p2<-ggplot(new_data, aes(x = age, y = predicted_outcome, color = mo_edu)) +
  geom_smooth() +
  labs(
    x = "Age (Months)",
    y = "Predicted Planetary Health Diet Index",
    color = "Mothers Education"
  ) +
  theme_minimal() + theme(plot.margin = margin(10,10,30,10))

p3<-ggplot(new_data, aes(x = wealth, y = predicted_outcome, color = res)) +
  geom_smooth() +
  labs(
    x = "Wealth Index",
    y = "Predicted Planetary Health Diet Index",
    color = "Residence"
  ) +
  theme_minimal() + theme(plot.margin = margin(30,10,10,10))

p4<-ggplot(new_data, aes(x = wealth, y = predicted_outcome, color = mo_edu)) +
  geom_smooth() +
  labs(
    x = "Wealth Index",
    y = "Predicted Planetary Health Diet Index",
    color = "Mothers Education"
  ) +
  theme_minimal() + theme(plot.margin = margin(30,10,10,10))


pf<-ggarrange(p1, p2, p3,p4, 
          ncol = 2, nrow = 2,
          heights = c(1, 1.2, 1, 1.2))
annotate_figure(pf,top = "Linear Predicted model")


###Linear regression model

p1<-ggplot(tb_data, aes(x = age, y = newPHI, colour = res)) + 
  geom_smooth(
    method = "lm",
    mapping = aes(weight = wt), span=0.3)+labs(x = "Age (months)", y = "Planetary health diet index",colour="Residence")

p2<-ggplot(tb_data, aes(x = wealth, y = newPHI, colour = mo_edu)) + 
  geom_smooth(
    method = "lm",
    mapping = aes(weight = wt), span=0.3)+labs(x = "Age (months)", y = "Planetary health diet index", colour="Mothers Education")

p3<-ggplot(tb_data, aes(x = wealth, y = newPHI, colour = res)) + 
  geom_smooth(
    method = "lm",
    mapping = aes(weight = wt), span=0.3)+labs(x = "Wealth index", y = "Planetary health diet index", colour="Residence")

p4<-ggplot(tb_data, aes(x = wealth, y = newPHI, colour = mo_edu)) + 
  geom_smooth(
    method = "lm",
    mapping = aes(weight = wt), span=0.3)+labs(x = "Wealth index", y = "Planetary health diet index", colour="Mothers Education")

pf<-ggarrange(p1, p2, p3,p4, 
              ncol = 2, nrow = 2,
              heights = c(1, 1.2, 1, 1.2))
annotate_figure(pf,top = "Linear Regression")


scatter.smooth(tb_data$newPHI,span = 2/3, family = c("symmetric"))

```



```{r}
# *** Among non-breastfeeding children ***
table_temp <-  KRiycf %>% 
  filter(nt_bf_curr==1) %>%
  cross_rpct(
    cell_vars = list(agecats,total()),
    col_vars = list(nt_formula, nt_milk, nt_juice,nt_soup_broth,nt_other_liq, nt_bbyfood, nt_bread_noodles,nt_vege,nt_dark_green_vege, 
                    nt_fruits, nt_other_fruits, nt_root,nt_meat,nt_organs,nt_fish, nt_nuts,nt_eggs, nt_dairy, nt_solids),
    weight = wt,
    total_label = "Weighted N",
    total_statistic = "w_cases",
    total_row_position = c("below"),
    expss_digits(digits=1)) %>%
  set_caption("Food and liquids consumed - bf children")
write.xlsx(table_temp, "~/Healthy diets for Afrika/DHS/DHS country datasets/Benin/Children_recode_BJKR71SD/Tables_bf.xlsx", sheetName = "foods_bfchild", append=TRUE)



# *** Among non-breastfeeding children ***
table_temp1 <-  KRiycf %>% 
  filter(nt_bf_curr==0) %>%
  cross_rpct(
    cell_vars = list(agecats,total()),
    col_vars = list(nt_formula, nt_milk, nt_liquids, nt_bbyfood, nt_grains, nt_vita, nt_frtveg, nt_root, 
                    nt_nuts, nt_meatfish, nt_eggs, nt_dairy, nt_solids),
    weight = wt,
    total_label = "Weighted N",
    total_statistic = "w_cases",
    total_row_position = c("below"),
    expss_digits(digits=1)) %>%
  set_caption("Food and liquids consumed - non-bf children")
write.xlsx(table_temp, "~/Healthy diets for Afrika/DHS/DHS country datasets/Benin/Children_recode_BJKR71SD/Tables_bf.xlsx", sheetName = "foods_bfchild", sheetName = "foods_nonbfchild", append=TRUE)
```


```{r}
table_temp <-  KRiycf %>% 
  filter(nt_bf_curr==1) %>%
  cross_rpct(
    cell_vars = list(agecats,total()),
    col_vars = list(nt_formula, nt_milk, nt_liquids, nt_bbyfood, nt_grains, nt_vita, nt_frtveg, nt_root, 
                    nt_nuts, nt_meat, nt_eggs, nt_dairy, nt_solids, nt_fish),
    weight = wt,
    total_label = "Weighted N",
    total_statistic = "w_cases",
    total_row_position = c("below"),
    expss_digits(digits=1)) %>%
  set_caption("Food and liquids consumed - bf children")

write.xlsx(table_temp, "~/Healthy diets for Afrika/DHS/DHS country datasets/Benin/Children_recode_BJKR71SD/Tables_bf.xlsx", sheetName = "foods_bfchild", append=TRUE)
```


```{r}
# //Consumed Vit A rich food
KRiycf <- KRiycf %>%
  mutate(nt_ch_micro_vaf  = 
           if_else(v414g==1 | v414h==1 | v414i==1 | v414j==1 | v414k==1 | v414m==1 | v414n==1, 1, 0 )) 
KRiycf[["nt_ch_micro_vaf"]] <- ifelse(KRiycf[["age"]]<6 | KRiycf[["age"]]>23  , NA, KRiycf[["nt_ch_micro_vaf"]])  
KRiycf <- KRiycf %>%
  set_value_labels(nt_ch_micro_vaf = c("Yes" = 1, "No"=0  )) %>%
  set_variable_labels(nt_ch_micro_vaf = "Youngest children age 6-23 mos living with mother given Vit A rich food")
```

```{r}
# //Consumed iron rich food
KRiycf <- KRiycf %>%
  mutate(nt_ch_micro_irf  = 
           if_else(v414g==1 | v414h==1 | v414m==1 | v414n==1, 1, 0 )) 
KRiycf[["nt_ch_micro_irf"]] <- ifelse(KRiycf[["age"]]<6 | KRiycf[["age"]]>23  , NA, KRiycf[["nt_ch_micro_irf"]])  
KRiycf <- KRiycf %>%
  set_value_labels(nt_ch_micro_irf = c("Yes" = 1, "No"=0  )) %>%
  set_variable_labels(nt_ch_micro_irf = "Youngest children age 6-23 mos living with mother given iron rich food")
```

```{r}
# //Age in months
KRdata <- KRdata %>%
  mutate(agemonths = case_when(age<6~ 1, age%in%c(6,7,8)~ 2, age%in%c(9,10,11)~ 3, age>=12&age<=17~ 4, 
                               age>=18&age<=23~ 5, age>=24&age<=35~ 6, age>=36&age<=47~ 7, age>=48&age<=59~ 8)) %>%
  set_value_labels(agemonths = c("<6"=1, "6-8"=2, "9-11"=3, "12-17"=4, "18-23"=5, "24-35"=6, "36-47"=7, "48-59"=8 )) %>%
  set_variable_labels(agemonths = "Age of child months categories: 0-59")

# //Age categories for children 0-23
KRdata <- KRdata %>%
  mutate(agecats = case_when(age<2~ 1, age%in%c(2,3)~ 2, age%in%c(4,5)~ 3, age%in%c(6,7,8)~ 4, 
                             age%in%c(9,10,11)~ 5, age>=12&age<=17~ 6, age>=18&age<=23~ 7, age>23~99)) %>%
  replace_with_na(replace = list(agecats = c(99))) %>%
  set_value_labels(agecats = c("0-1"=1, "2-3"=2, "4-5"=3, "6-8"=4, "9-11"=5, "12-17"=6, "18-23"=7 )) %>%
  set_variable_labels(agecats = "Age of child months categories: 0-23")


```

```{r}
# //Place of delivery
KRdata <- KRdata %>%
  mutate(del_place = case_when(inrange(m15,20,39)~ 1, inrange(m15,10,19)~ 2, inrange(m15,40,99)~ 3)) %>%
  set_value_labels(del_place = c("Health facility"=1, "Home"=2, "Other/Missing"=3 )) %>%
  set_variable_labels(del_place = "Place of delivery")
```

```{r}
# //Assistance during delivery
# **Note: Assistance during delivery are country specific indicators. Check final report to know if these are coded correctly. 
KRdata <- KRdata %>%
  mutate(del_pv =
           case_when(
             m3a == 1 | m3b == 1 |  m3c == 1 | m3d == 1 | m3e == 1 | m3f == 1 ~ 1 ,
             m3g == 1 ~ 2 ,
             m3h == 1 | m3i == 1 | m3j == 1 | m3k == 1 | m3l == 1 | m3m == 1 ~ 3 ,
             m3n ==1 ~ 4,
             m3a ==8 | m3a==9 | age>=60 ~ 99)) %>%
  replace_with_na(replace = list(del_pv = c(99))) %>%
  set_value_labels(del_pv = c("Health personnel" = 1, "Traditional birth attendant"=2, "Other"=3, "No one"=4  )) %>%
  set_variable_labels(del_pv = "Assistance during delivery")
```

```{r}
# //Mother's age 
KRdata <- KRdata %>%
  mutate(agem = case_when(v013==1  ~ 1, v013 %in% c(2,3) ~ 2, v013 %in% c(4,5) ~ 3, v013%in% c(6,7) ~ 4, v013>7 ~ 5 )) %>%
  set_value_labels(agem = c("15-19"=1, "20-29"=2, "30-39"=3, "40-49"=4, "50+"=5)) %>%
  set_variable_labels(agem = "Mother's age categories")
```

```{r}
# //Age categories for children 0-23
KRiycf <- KRiycf %>%
  mutate(agecats = case_when(age<2~ 1, age%in%c(2,3)~ 2, age%in%c(4,5)~ 3, age%in%c(6,7,8)~ 4, 
                             age%in%c(9,10,11)~ 5, age>=12&age<=17~ 6, age>=18&age<=23~ 7, age>23~99)) %>%
  replace_with_na(replace = list(agecats = c(99))) %>%
  set_value_labels(agecats = c("0-1"=1, "2-3"=2, "4-5"=3, "6-8"=4, "9-11"=5, "12-17"=6, "18-23"=7 )) %>%
  set_variable_labels(agecats = "Age of child months categories: 0-23")


# //Mother's age 
KRiycf <- KRiycf %>%
  mutate(agem = case_when(v013==1  ~ 1, v013 %in% c(2,3) ~ 2, v013 %in% c(4,5) ~ 3, v013%in% c(6,7) ~ 4, v013>7 ~ 5 )) %>%
  set_value_labels(agem = c("15-19"=1, "20-29"=2, "30-39"=3, "40-49"=4, "50+"=5)) %>%
  set_variable_labels(agem = "Mother's age categories")

table_temp <-  KRiycf %>% 
  cross_rpct(
    cell_vars = list(agecats, total()),
    col_vars = list(nt_bf_status, nt_bf_curr),
    weight = wt,
    total_label = "Weighted N",
    total_statistic = "w_cases",
    total_row_position = c("below"),
    expss_digits(digits=1)) %>%
  set_caption("Breast feeding status")
write.xlsx(table_temp, "~/Healthy diets for Afrika/DHS/DHS country datasets/Benin/Children_recode_BJKR71SD/Tables_bf.xlsx", sheetName = "bfstatus", append=TRUE)
```
